<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Stock Chart</title>
    <link rel="stylesheet" href="/stylesheets/stockChart.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <!-- Needed for time scaling -->
  </head>

  <body>
    <h2 id="title">Stock: ...</h2>

    <div class="chart-section">
      <h3>Past & Current Performance (10 Years)</h3>
      <canvas id="historicalChart" width="300" height="100"></canvas>
    </div>

    <div class="chart-section">
      <h3>Future Price Prediction (1 Week)</h3>
      <canvas id="predictionChart" width="300" height="80"></canvas>
    </div>
    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const symbol = urlParams.get("symbol");

      if (!symbol) {
        alert("No stock symbol provided.");
        throw new Error("Missing stock symbol in URL query.");
      }

      document.getElementById("title").innerText = `Stock: ${symbol}`;

      async function fetchHistoricalData() {
        try {
          const res = await fetch(`/stocks/chart-data?symbol=${symbol}`);
          return await res.json();
        } catch (err) {
          console.error("Failed to fetch historical data:", err);
          return [];
        }
      }

      async function drawCharts() {
        const data = await fetchHistoricalData();
        console.log("Data", symbol, data);

        if (data.length > 0) {
          const labels = data.map((d) => new Date(d.timestamp));
          const prices = data.map((d) => d.close_price);

          new Chart(document.getElementById("historicalChart"), {
            type: "line",
            data: {
              labels,
              datasets: [
                {
                  label: "Close Price",
                  data: prices,
                  borderColor: "rgba(75, 192, 192, 1)",
                  backgroundColor: "rgba(75, 192, 192, 0.1)",
                  tension: 0.3,
                  fill: true,
                },
              ],
            },
            options: {
              responsive: true,
              scales: {
                x: {
                  type: "time",
                  time: {
                    unit: "year", // key change: year-based ticks
                    tooltipFormat: "yyyy-MM-dd",
                    displayFormats: {
                      year: "yyyy",
                    },
                  },
                  title: {
                    display: true,
                    text: "Year",
                  },
                  ticks: {
                    maxTicksLimit: 10,
                  },
                },
                y: {
                  title: {
                    display: true,
                    text: "Close Price",
                  },
                },
              },
            },
          });

          const predictionDays = 7;
          const movingAvgDays = 10;
          const recentPrices = prices.slice(-movingAvgDays);
          const avg =
            recentPrices.reduce((sum, p) => sum + parseFloat(p), 0) /
            movingAvgDays;

          const predictionData = Array(predictionDays).fill(avg);
          const predictionLabels = Array(predictionDays)
            .fill(0)
            .map((_, i) => `Day ${i + 1}`);

          new Chart(document.getElementById("predictionChart"), {
            type: "line",
            data: {
              labels: predictionLabels,
              datasets: [
                {
                  label: "Predicted Close Price",
                  data: predictionData,
                  borderColor: "rgba(255, 99, 132, 1)",
                  backgroundColor: "rgba(255, 99, 132, 0.2)",
                  tension: 0.3,
                  fill: true,
                },
              ],
            },
          });
        }
      }
      drawCharts();
    </script>
  </body>
</html>

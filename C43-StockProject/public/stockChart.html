<!DOCTYPE html>
<html>
  <head>
    <title>Stock Chart</title>
    <link rel="stylesheet" href="/stylesheets/stockChart.css" />
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        padding: 40px;
        text-align: center;
      }

      .interval-buttons {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .interval-buttons button {
        padding: 10px 16px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s, transform 0.2s;
      }

      .interval-buttons button.active {
        background-color: #0056b3;
        transform: scale(1.05);
      }

      canvas {
        display: block;
        margin: 30px auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
      }

      h3 {
        margin-top: 50px;
      }
    </style>
  </head>

  <body>
    <h2 id="chartTitle">ðŸ“ˆ Loading Chart...</h2>

    <div class="interval-buttons">
      <button data-interval="1w">1 Week</button>
      <button data-interval="1m" class="active">1 Month</button>
      <button data-interval="1y">1 Year</button>
      <button data-interval="5y">5 Years</button>
      <button data-interval="all">All Time</button>
    </div>

    <!-- Historical Chart -->
    <canvas id="stockChart" width="800" height="400"></canvas>

    <!-- Prediction Chart -->
    <h3>ðŸ“ˆ Prediction for the Next Week</h3>
    <canvas id="predictionChart" width="800" height="400"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const symbol = localStorage.getItem("selectedStock");
      const chartTitle = document.getElementById("chartTitle");
      let chart, predictionChart;

      async function loadChart(interval) {
        chartTitle.textContent = `${symbol} Stock Chart (${interval.toUpperCase()})`;

        document.querySelectorAll(".interval-buttons button").forEach((btn) => {
          btn.classList.remove("active");
          if (btn.dataset.interval === interval) btn.classList.add("active");
        });

        let labels = [];
        let prices = [];

        try {
          const res = await fetch(
            `/stocks/history?symbol=${symbol}&interval=${interval}`
          );
          if (res.ok) {
            const data = await res.json();
            if (Array.isArray(data) && data.length > 0) {
              labels = data.map((point) => point.date);
              prices = data.map((point) => point.close);
            }
          }
        } catch (err) {
          console.error("Failed to fetch data:", err);
        }

        // --- Historical Chart ---
        if (chart) chart.destroy();
        const ctx = document.getElementById("stockChart").getContext("2d");
        chart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: `${symbol} Closing Price`,
                data: prices,
                borderColor: "#007bff",
                borderWidth: 2,
                fill: false,
                pointRadius: 0,
                tension: 0.1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
            },
            scales: {
              x: { title: { display: true, text: "Date" } },
              y: {
                title: { display: true, text: "Price (USD)" },
                beginAtZero: false,
              },
            },
          },
        });

        // --- Prediction Chart ---
        if (predictionChart) predictionChart.destroy();
        const ctx2 = document
          .getElementById("predictionChart")
          .getContext("2d");

        const last30 = prices.slice(-30);
        const futureLabels = [];
        const prediction = [];

        if (last30.length > 1) {
          const n = last30.length;
          const x = Array.from({ length: n }, (_, i) => i + 1);
          const y = last30.map(Number);

          const xSum = x.reduce((a, b) => a + b, 0);
          const ySum = y.reduce((a, b) => a + b, 0);
          const xySum = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
          const x2Sum = x.reduce((sum, xi) => sum + xi * xi, 0);

          const slope = (n * xySum - xSum * ySum) / (n * x2Sum - xSum ** 2);
          const intercept = (ySum - slope * xSum) / n;

          for (let i = 1; i <= 7; i++) {
            const futureX = n + i;
            const predictedY = slope * futureX + intercept;
            prediction.push(predictedY.toFixed(2));
            futureLabels.push(`Day +${i}`);
          }
        }

        predictionChart = new Chart(ctx2, {
          type: "line",
          data: {
            labels: futureLabels,
            datasets: [
              {
                label: "Predicted Closing Price",
                data: prediction,
                borderColor: "#28a745",
                borderWidth: 2,
                pointRadius: 3,
                tension: 0.1,
                fill: false,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
            },
            scales: {
              x: { title: { display: true, text: "Future Days" } },
              y: {
                title: { display: true, text: "Price (USD)" },
                beginAtZero: false,
              },
            },
          },
        });
      }

      document.querySelectorAll(".interval-buttons button").forEach((btn) => {
        btn.addEventListener("click", () => loadChart(btn.dataset.interval));
      });

      loadChart("all");
    </script>
  </body>
</html>

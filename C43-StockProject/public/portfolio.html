<!DOCTYPE html>
<html>
  <head>
    <title>Portfolio Details</title>
    <link rel="stylesheet" href="/stylesheets/portfolio.css" />
  </head>

  <body>
    <button id="stocks" style="float: left">Go to Stocks</button>

    <div class="portfolio-info">
      <h2>Portfolio Overview</h2>
      <p id="cashAmount">Loading...</p>

      <h3>Stock Holdings</h3>
      <ul id="stockList">
        <li>Loading...</li>
      </ul>

      <button onclick="handleDeposit()">Deposit</button>
      <button onclick="handleWithdraw()">Withdraw</button>
    </div>

    <script>
      const portfolioID = localStorage.getItem("selectedPortfolioID");

      async function fetchPortfolio() {
        try {
          const res = await fetch("/portfolio/my");
          const data = await res.json();

          const selected = data.find((p) => p.portfolioid == portfolioID);
          if (selected) {
            document.getElementById("cashAmount").innerText =
              "Cash Balance: $" + Number(selected.cashamount).toFixed(2);
          } else {
            document.getElementById("cashAmount").innerText =
              "Portfolio not found!";
          }
        } catch (err) {
          console.error("Failed to load portfolio:", err);
        }
      }

      async function loadHoldings() {
        try {
          const res = await fetch(
            `/portfolio/holdings?portfolioID=${portfolioID}`
          );
          const data = await res.json();
          const ul = document.getElementById("stockList");
          ul.innerHTML = "";

          if (data.length === 0) {
            ul.innerHTML = "<li>None</li>";
            return;
          }

          data.forEach((row) => {
            const li = document.createElement("li");
            li.textContent = `${row.symbol}: ${row.volume} shares`;
            ul.appendChild(li);
          });
        } catch (err) {
          console.error("Failed to load holdings:", err);
          document.getElementById("stockList").innerHTML =
            "<li>Error loading holdings</li>";
        }
      }

      async function handleDeposit() {
        const amount = prompt("Enter deposit amount:");
        if (!amount || isNaN(amount) || Number(amount) <= 0)
          return alert("Invalid amount");

        const res = await fetch("/portfolio/deposit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ portfolioID, amount }),
        });

        if (res.ok) {
          alert("Deposit successful!");
          await fetchPortfolio();
        } else {
          alert("Deposit failed.");
        }
      }

      async function handleWithdraw() {
        const amount = prompt("Enter amount to withdraw:");
        if (!amount || isNaN(amount) || Number(amount) <= 0)
          return alert("Invalid amount");

        const res = await fetch("/portfolio/withdraw", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ portfolioID, amount }),
        });

        const data = await res.json();
        if (res.ok) {
          alert("Withdrawal successful!");
          await fetchPortfolio();
        } else {
          alert("Error: " + data.error);
        }
      }

      // Load on page load
      fetchPortfolio().then(loadHoldings);

      document.getElementById("stocks").addEventListener("click", () => {
        window.location.href = "/stocksHome.html";
      });
    </script>
  </body>
</html>
